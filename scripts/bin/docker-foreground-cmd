#!/bin/sh

set -eu

# Dump environment variables
export-env >> ~/.profile

# Generate self-signed certificate if it does not exist
if [ ! -f '/var/lib/knot-resolver/ssl/server.key' ] || [ ! -f '/var/lib/knot-resolver/ssl/server.crt' ]; then
	renew-self-signed-cert
fi

# Download blacklist zone if it does not exist
if [ ! -f '/var/lib/knot-resolver/hblock.rpz' ]; then
	update-blacklist-rpz
fi

# Download GeoIP database if it does not exist
if [ ! -f '/var/lib/knot-resolver/geoip.mmdb' ]; then
	update-geoip-database
fi

# Run runit
exec runsvdir -P ~/service/
