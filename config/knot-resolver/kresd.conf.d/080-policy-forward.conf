-- DNS over TLS forwarding
-- https://dnsprivacy.org/wiki/display/DP/DNS+Privacy+Public+Resolvers#DNSPrivacyPublicResolvers-DNS-over-TLS(DoT)

local servers = {}
local ca_file = '/etc/ssl/certs/ca-certificates.crt'

for i = 1,4 do
	local ip = env['KRESD_DNS' .. i .. '_IP']

	if ip ~= nil and ip ~= '' then
		local hostname = env['KRESD_DNS' .. i .. '_HOSTNAME']
		local pin_sha256 = env['KRESD_DNS' .. i .. '_PIN_SHA256']
	
		if hostname ~= nil and hostname ~= '' then
			io.stdout:write('DoT server ' .. i .. ': ' .. ip .. ' (hostname = ' .. hostname .. ')\n')
			table.insert(servers, { ip, hostname = hostname, ca_file = ca_file })
		elseif pin_sha256 ~= nil and pin_sha256 ~= '' then
			io.stdout:write('DoT server ' .. i .. ': ' .. ip .. ' (pin_sha256 = ' .. pin_sha256 .. ')\n')
			table.insert(servers, { ip, pin_sha256 = pin_sha256 })
		end
	end
end

policy.add(policy.all(policy.TLS_FORWARD(servers)))
